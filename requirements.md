# PhyModel / ER15-1400 — Requirements

## 1. 背景与目标

本项目目标是：为 **ER15-1400** 建立「足够真实」的物理特性与 **刚柔动力学模型**（以 MuJoCo 为主），用于后续控制/优化/数字孪生/参数辨识等工作。

现阶段仓库已具备最小可用骨架：

- `models/er15-1400.mjcf.xml`：可加载的 MJCF（当前默认禁用碰撞，便于先跑通控制/跟踪调试）。
- `phymodel/mjcf/validator.py` + `scripts/validate_mjcf.py`：MJCF 基础校验与摘要输出（网格存在性、关节命名/限位、惯量缺失提示等）。
- `phymodel/kinematics/mujoco_fk.py`：最小 FK 例程（用于确认位姿刷新链路正确）。

## 2. 适用范围（Scope）

### 2.1 包含

- 机器人结构：ER15-1400 6 轴（关节、连杆、几何、惯量）。
- 动力学：刚体动力学（MuJoCo 质心/惯量/关节链）、驱动/传动简化、摩擦、阻尼。
- 接触：环境接触、必要自碰/邻接碰撞过滤策略、接触参数可配置与回归。
- 柔顺/柔性：关节/传动弹性、间隙（backlash）近似；必要时末端/长臂的低阶柔性（lumped 或 modal 近似）。
- 参数化：工具/工件载荷（质量、质心、惯量）、关节摩擦与阻尼、接触参数等可版本化配置。
- 校验与评估：模型可加载性、几何/惯量一致性、FK/IK 对照（至少 FK）、基础动力学 sanity checks。

### 2.2 不包含（Non-goals，短期）

- 完整控制器/优化器实现（本仓库刻意保持 “世界模型” 轻量化）。
- 高保真电机电控闭环（如电流环/驱动器非线性）与热效应等细节（可在后续扩展）。
- 多物理场（流体/温度）耦合。

## 3. 用户故事（Use Cases）

- 控制开发：给定关节轨迹/控制输入，仿真得到合理的关节状态与末端位姿/力学响应。
- 参数辨识：用实机日志（或标定实验）回归摩擦/阻尼/接触/柔顺参数，并能复现实验现象。
- 数字孪生：在不同工况（工具/负载/速度）下保持行为一致性，并能解释误差来源。

## 4. 功能性需求（Functional Requirements）

### 4.1 模型加载与一致性

- FR-1：支持从 `models/er15-1400.mjcf.xml` 加载模型，且能在 CI/本地快速验证（无图形界面依赖）。
- FR-2：提供 MJCF 静态校验：网格文件存在、关节命名唯一、关节限位合法、关键 option/单位约束提示。
- FR-3：提供 “参数集（parameter set）” 概念：同一 MJCF 下可切换不同物理参数（例如：无碰撞调试 / 带碰撞真实 / 不同末端工具）。

### 4.2 运动学校验

- FR-4：提供 FK 校验入口：对给定 `q` 输出指定 body/site 的位置/姿态，并与期望值（或对照实现）比对。
- FR-5：关键坐标系约定清晰（base、各 link、TCP、工具坐标系），并能在模型中以 site 标注（建议）。

### 4.3 动力学与驱动

- FR-6：支持关节阻尼/摩擦（Coulomb + viscous 为起点）的参数化；能区分不同关节的参数。
- FR-7：支持驱动建模的最小闭环：给定 `ctrl`（力矩或位置/速度伺服），能稳定仿真并输出关节状态。
- FR-8：支持工具/负载参数化（质量、质心、惯量；可附着到末端 link 或 tool body）。

### 4.4 接触与碰撞

- FR-9：支持碰撞开关与分层策略：
  - 调试模式：如当前 MJCF 一样，可关闭几何碰撞/接触，便于排除控制问题。
  - 真实模式：启用必要碰撞（与地面/工件/夹具），并可配置自碰与邻接碰撞过滤。
- FR-10：接触参数（摩擦、restitution、softness、solref/solimp 等）可配置、可回归、可对比。

### 4.5 刚柔耦合（逐步引入）

- FR-11：支持关节/传动柔顺近似（弹簧-阻尼）并可在不改变上层接口的前提下启用/禁用。
- FR-12：当需要结构柔性时，支持至少一种低阶柔性表示（例如在关键 link 加入等效弹簧-阻尼/质量点）。

## 5. 非功能性需求（Non-functional Requirements）

- NFR-1（可复现）：同一参数集下，仿真结果在固定随机种子/固定积分步长时可复现。
- NFR-2（可维护）：模型参数、标定数据、脚本入口分层清晰；变更有文档与变更记录。
- NFR-3（可验证）：每次修改 MJCF 或关键参数，都有快速校验脚本可跑（秒级到分钟级）。
- NFR-4（性能）：单次前向仿真可满足迭代调参需求（目标：单步/短 horizon 在 CPU 上可用）。
- NFR-5（约定）：明确单位（长度 m、质量 kg、角度 rad、力 N、力矩 N·m），并在校验中提示常见错误。

## 6. 验收标准（Acceptance Criteria，阶段性）

阶段性验收建议按 “由易到难、由稳定到真实”：

1. A0：MJCF 可加载；`scripts/validate_mjcf.py` 输出 `ok=true` 且摘要合理（已满足）。
2. A1：具备明确的 `timestep/gravity` 等 option，且 FK 校验在典型姿态下稳定、坐标系一致。
3. A2：在关闭自碰的前提下启用必要接触（地面/工件），控制/轨迹跟踪不被“碰撞打架”破坏。
4. A3：摩擦/阻尼/驱动参数可切换与回归，能复现至少一组标定实验现象（如空载匀速、反向间隙等）。
5. A4：引入柔顺/柔性后，能解释并复现典型振动/超调/延迟（在可控复杂度下）。

