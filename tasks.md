# PhyModel / ER15-1400 — Tasks & Roadmap

> 说明：本文件把目标拆成可落地的工程任务（优先级/验收标准/交付物）。任务按 “先可控、后逼真” 排序，避免一次性引入过多非线性导致难以定位问题。

## 0. 当前状态（Baseline）

- 已有：`models/er15-1400.mjcf.xml` 可加载（静态校验通过），并默认关闭碰撞/接触；`scripts/validate_mjcf.py` 可输出 JSON 摘要；存在最小 FK helper。
- 待补：仿真 option 显式化（timestep/gravity），site/TCP 约定，驱动与参数集框架。

## 1. P0 — 工程化与模型卫生（1~2 天量级）

- [ ] 明确 Python 入口：脚本与 README 统一使用 `python3`（当前环境无 `python` 命令）。
- [ ] 在 MJCF 中补齐 `<option timestep gravity>`（并在 `validator.py` 中升级为强提示/可选错误）。
- [ ] 增加 site 约定：在末端增加 `site name="tcp"`（或 `flange`/`tool0`），作为 FK/标定统一引用点。
- [ ] `phymodel/kinematics/` 增加 FK 的姿态输出（位置 + 四元数/旋转矩阵），并提供 CLI：`scripts/check_fk.py`。
- [ ] 校验增强：
  - [ ] 检查 joint axis/pos 合法性（缺失时报错）
  - [ ] 检查 inertial mass/diaginertia 合理范围（异常给 warning）
  - [ ] 输出关节限位表（便于核对）

验收（A1）：

- `scripts/validate_mjcf.py` 不再提示 option 缺失；
- `scripts/check_fk.py` 在典型姿态下输出稳定且坐标系一致的 TCP 位姿。

## 2. P1 — 碰撞/接触分层（可控地打开“真实”）

> 当前 MJCF 将所有 geom 设为 `contype=0/conaffinity=0`，适合排查控制问题，但无法用于接触任务与更真实动力学。

- [ ] 将几何拆分为 `visual geom` 与 `collision geom`（碰撞几何可先用简化 primitive 或简化网格）。
- [ ] 引入模式开关（参数集或构建脚本）：
  - [ ] `debug_no_contact`：全部禁用碰撞（保持现状）
  - [ ] `contact_env_only`：仅与地面/工件碰撞，自碰仍禁用
  - [ ] `contact_full`：逐步恢复必要自碰（带过滤清单）
- [ ] 自碰/邻接碰撞过滤清单工程化：
  - [ ] 保留邻接 exclude（已存在）
  - [ ] 增加可配置的额外 exclude（如特定 link 对）
  - [ ] 增加“碰撞对统计/日志”（仿真中记录发生接触的 body/geom 对）
- [ ] 接触参数基线：
  - [ ] 为地面、工件、link- link 分别配置摩擦/solref/solimp（先给经验值，后回归）

验收（A2）：

- 在 `contact_env_only` 下，机器人与地面/工件接触稳定，不出现“碰撞打架”导致的发散；
- 能输出接触对统计，便于定位异常接触来源。

## 3. P2 — 驱动、摩擦、阻尼（从“能跑”到“像真”）

- [ ] 建立关节动力学参数表（按关节维度）：
  - [ ] viscous damping（`damping`）
  - [ ] Coulomb/静摩擦近似（MuJoCo 可用 `frictionloss`/自定义控制律近似）
  - [ ] armature（等效转子惯量）
- [ ] 增加 actuator 方案（至少一种）：
  - [ ] torque control（力矩直控，用于动力学辨识/基准）
  - [ ] （可选）position/velocity servo（用于接近实机伺服行为）
- [ ] 增加最小仿真脚本 `scripts/sim_step.py`：
  - [ ] 加载参数集
  - [ ] 跑固定步数
  - [ ] 输出状态（q, qd, tau/ctrl）、能量、接触统计（若启用）

验收（A3-基础）：

- torque 模式下，给定小扰动不会数值爆炸；阻尼与摩擦能产生可解释的能量衰减；
- 不同参数集切换后行为可预测（例如摩擦增大→稳态误差增大/能量衰减更快）。

## 4. P3 — 载荷与工具（工况切换能力）

- [ ] 末端 payload 参数化：
  - [ ] 质量/质心/惯量/安装位姿
  - [ ] 工具模型（可选 mesh + collision）
- [ ] 提供 `payload` 的配置文件与示例（空载、典型工具、典型工件）。

验收：

- 切换 payload 后，重力矩/动态响应变化符合直觉与量纲。

## 5. P4 — 柔顺/间隙（刚柔耦合第一步）

- [ ] 关节/传动弹性：每轴等效扭簧-阻尼（可启用/禁用）。
- [ ] 间隙（backlash）近似策略选型并实现（先从可控的近似开始）：
  - [ ] 分段死区模型（外部控制律）
  - [ ] 或等效双弹簧/滞回近似（视稳定性与可辨识性）
- [ ] 标定实验脚本（离线）：阶跃/正反向扫频/匀速反向，输出误差指标。

验收（A4-基础）：

- 在加入柔顺/间隙后，能复现“方向反转迟滞/振动/超调”等定性现象，并可通过参数调节解释变化趋势。

## 6. P5 — 结构柔性（低阶模型）

- [ ] 选择柔性建模方案（优先低阶）：
  - [ ] 关键 link 的 lumped compliance（末端/长臂）
  - [ ] 或 modal 低阶（若需要更真实的共振频率）
- [ ] 与实测或设计指标对齐：共振频率范围、阻尼比范围。

验收：

- 在指定激励下出现合理共振峰；调整柔性参数可移动共振频率/幅值。

## 7. P6 — 参数辨识与回归（长期）

- [ ] 定义日志格式与数据接口（实机/仿真统一字段）：
  - `t, q, qd, qdd?, tau_cmd, tau_est?, tcp_pose, contact?`
- [ ] 回归目标函数与指标：轨迹误差、力矩误差、能量、接触事件一致性等。
- [ ] 建立回归测试集（几组固定实验），并将 “模型版本 + 参数集版本” 固化到结果中。

## 8. 风险与注意事项

- 碰撞/接触是最常见的“看起来像动力学错了”的根因：必须保留可快速关闭接触的调试模式。
- 柔顺/间隙/摩擦高度耦合：建议分阶段引入，并为每次引入添加最小可复现实验与回归指标。
- 不要过早追求“所有细节都真实”：优先让模型可解释、可标定、可切换工况。

