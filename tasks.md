# PhyModel / ER15-1400 — Tasks & Roadmap（以摩擦建模为中心）

> 说明：本文件把目标拆成可落地的工程任务（优先级/验收标准/交付物）。
>
> 当前阶段以 **关节摩擦建模与可视化验证** 为中心：尽早在仿真里“看见摩擦”，并能用曲线/指标驱动调参与辨识。

## 0. 当前状态（Baseline）

- 已有：`models/er15-1400.mjcf.xml` 可加载（静态校验通过），并默认关闭碰撞/接触；`scripts/validate_mjcf.py` 可输出 JSON 摘要；存在最小 FK helper。
- 待补：摩擦建模与参数化框架、仿真可视化（viewer）、曲线输出（q/qd/τ 等）。

## 1. P0 — 摩擦建模最小闭环（最高优先级）

目标：在开发早期就能通过 **可视化 + 曲线** 看到摩擦效应，并能稳定地做参数对比与回归。

- [ ] 实现摩擦模型库（按关节维度参数化）：
  - [ ] 粘性 + 库伦（viscous + Coulomb）作为基线
  - [ ] LuGre（含静摩擦/预滑移）作为高保真选项
  - [ ] 支持 `enable/disable` 与 “只对指定关节生效”（便于单轴实验）
- [ ] 实现最小仿真脚本（无 GUI 也能跑）：
  - [ ] `scripts/run_friction_demo.py`：对选定关节施加激励（力矩/速度扫频/往复），记录 `q, qd, tau_cmd, tau_fric, qfrc_bias(可选)` 等
  - [ ] 输出曲线图（PNG）与原始数据（CSV 或 NPZ），固定落在 `artifacts/`
- [ ] 实现 viewer 可视化（开发者体验优先）：
  - [ ] `scripts/view_friction.py`：MuJoCo viewer 中运行同一 demo（可切换开启/关闭摩擦，便于直观看差异）
- [ ] 建立摩擦参数集（先给默认值，再逐步辨识）：
  - [ ] `params/friction_default.json`（或 yaml）包含每关节参数（Fc/Fs/vs/σ0/σ1/σ2 等）
  - [ ] 运行时打印参数快照，保证可复现

验收（F0）：

- 在同一激励下，开启/关闭摩擦能明显改变响应（如速度零附近的滞回/爬行、稳态误差、能量衰减）。
- 能一键生成曲线图与数据文件，并可重复复现。

## 2. P1 — 工程化与模型卫生（为摩擦服务）

- [ ] 统一入口与环境：脚本/README 统一使用 `python3` 与 `mjwarp_env`。
- [ ] 在 MJCF 中补齐 `<option timestep gravity>`（并在 `validator.py` 中升级为强提示/可选错误）。
- [ ] 增加 site 约定：`site name="tcp"`（或 `flange`/`tool0`），为后续标定/载荷/控制提供稳定引用点。

验收：

- `scripts/validate_mjcf.py` 不再提示 option 缺失；
- demo/可视化脚本在不同机器上可跑（至少无 GUI 的曲线输出可跑）。

## 3. P2 — 驱动/伺服接口（让摩擦与实机更可比）

- [ ] torque control（力矩直控，作为摩擦辨识/基准）
- [ ] （可选）velocity/position 伺服器（接近实机伺服行为，便于对齐日志）
- [ ] 日志字段与指标统一：`t, q, qd, tau_cmd, tau_fric, ...`

## 4. P3 — 载荷与工具（避免把载荷误差当成摩擦）

- [ ] 末端 payload 参数化：
  - [ ] 质量/质心/惯量/安装位姿
  - [ ] 工具模型（可选 mesh + collision）
- [ ] 提供 `payload` 的配置文件与示例（空载、典型工具、典型工件）。

验收：

- 切换 payload 后，重力矩/动态响应变化符合直觉与量纲。

## 5. P4 — 柔顺/间隙（与摩擦强耦合，后置但需预留接口）

- [ ] 关节/传动弹性：每轴等效扭簧-阻尼（可启用/禁用）。
- [ ] 间隙（backlash）近似策略选型并实现（先从可控的近似开始）：
  - [ ] 分段死区模型（外部控制律）
  - [ ] 或等效双弹簧/滞回近似（视稳定性与可辨识性）
- [ ] 标定实验脚本（离线）：阶跃/正反向扫频/匀速反向，输出误差指标。

验收（A4-基础）：

- 在加入柔顺/间隙后，能复现“方向反转迟滞/振动/超调”等定性现象，并可通过参数调节解释变化趋势。

## 6. P5 — 碰撞/接触分层（在摩擦基本可信后再引入）

> 接触/碰撞是最常见的“看起来像动力学/摩擦错了”的根因，因此在摩擦基线稳定前不优先推进。

- [ ] 将几何拆分为 `visual geom` 与 `collision geom`（碰撞几何可先用简化 primitive 或简化网格）。
- [ ] 引入模式开关（参数集或构建脚本）：
  - [ ] `debug_no_contact`：全部禁用碰撞（保持现状）
  - [ ] `contact_env_only`：仅与地面/工件碰撞，自碰仍禁用
  - [ ] `contact_full`：逐步恢复必要自碰（带过滤清单）
- [ ] 碰撞对统计/日志：记录发生接触的 body/geom 对（便于定位异常接触）。

验收：

- 在 `contact_env_only` 下与地面/工件接触稳定，且不会掩盖摩擦效应。

## 7. P6 — 结构柔性（低阶模型）

- [ ] 选择柔性建模方案（优先低阶）：
  - [ ] 关键 link 的 lumped compliance（末端/长臂）
  - [ ] 或 modal 低阶（若需要更真实的共振频率）
- [ ] 与实测或设计指标对齐：共振频率范围、阻尼比范围。

验收：

- 在指定激励下出现合理共振峰；调整柔性参数可移动共振频率/幅值。

## 8. P7 — 参数辨识与回归（以摩擦为第一目标）

- [ ] 定义日志格式与数据接口（实机/仿真统一字段）：
  - `t, q, qd, qdd?, tau_cmd, tau_est?, tcp_pose, contact?`
- [ ] 回归目标函数与指标：轨迹误差、力矩误差、能量、接触事件一致性等。
- [ ] 建立回归测试集（几组固定实验），并将 “模型版本 + 参数集版本” 固化到结果中。

## 8. 风险与注意事项

- 碰撞/接触是最常见的“看起来像动力学错了”的根因：必须保留可快速关闭接触的调试模式。
- 柔顺/间隙/摩擦高度耦合：建议分阶段引入，并为每次引入添加最小可复现实验与回归指标。
- 不要过早追求“所有细节都真实”：优先让模型可解释、可标定、可切换工况。
